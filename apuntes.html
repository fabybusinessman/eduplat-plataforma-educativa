<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPlat - Mis Apuntes</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        :root {
            --primary-color: #4a90e2; --background-light: #f8f9fa;
            --text-dark: #343a40; --text-light: #6c757d;
            --border-color: #dee2e6; --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-light); display: flex; min-height: 100vh; }

        /* Sidebar Navegaci√≥n */
        .sidebar { width: 260px; background: white; height: 100vh; position: fixed; border-right: 1px solid var(--border-color); padding: 30px 20px; }
        .nav-link { text-decoration: none; color: var(--text-light); display: flex; padding: 12px; gap: 12px; border-radius: 8px; margin-bottom: 5px; }
        .nav-link.active { background: #eef5ff; color: var(--primary-color); font-weight: 600; }

        /* Contenido Principal */
        .main-content { margin-left: 260px; width: calc(100% - 260px); padding: 30px; display: flex; flex-direction: column; }
        
        .notes-layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; margin-top: 20px; flex-grow: 1; }
        
        /* Panel de Carpetas */
        .folders-panel { background: white; border-radius: 12px; padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .folder-item { 
            padding: 12px; cursor: pointer; border-radius: 8px; margin-bottom: 8px; 
            display: flex; align-items: center; gap: 10px; transition: 0.2s;
        }
        .folder-item:hover { background: #f0f7ff; }
        .folder-item.active { background: var(--primary-color); color: white; }

        .btn-add { width: 100%; padding: 10px; border: 2px dashed var(--primary-color); color: var(--primary-color); background: white; border-radius: 8px; cursor: pointer; margin-bottom: 20px; font-weight: bold; }

        /* Editor */
        .editor-container { background: white; border-radius: 12px; padding: 25px; box-shadow: var(--shadow); border: 1px solid var(--border-color); display: flex; flex-direction: column; }
        #notes-area { flex-grow: 1; width: 100%; border: 1px solid #eee; border-radius: 10px; padding: 20px; font-family: inherit; font-size: 1rem; resize: none; outline: none; margin-top: 15px; }
        
        .btn-save { background: var(--primary-color); color: white; border: none; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 600; }
    </style>
</head>
<body>

    <aside class="sidebar">
        <h2 style="color:var(--primary-color); margin-bottom: 30px;">üéì EduPlat</h2>
        <nav>
            <a href="dashboard.html" class="nav-link">üè† Dashboard</a>
            <a href="cursos.html" class="nav-link">üìö Mis Cursos</a>
            <a href="apuntes.html" class="nav-link active">üìù Apuntes</a>
            <a href="cerrarsesion.html" class="nav-link" style="margin-top:30px; color:red;">üö™ Salir</a>
        </nav>
    </aside>

    <main class="main-content">
        <header style="display:flex; justify-content:space-between; align-items:center;">
            <h1>Gesti√≥n de Apuntes</h1>
            <div id="user-info" style="display:flex; align-items:center; gap:10px;">
                <span id="user-name" style="font-weight:500;">Usuario</span>
                <img id="user-photo" src="" style="width:35px; border-radius:50%;">
            </div>
        </header>

        <div class="notes-layout">
            <aside class="folders-panel">
                <button class="btn-add" id="add-folder">+ Nueva Carpeta</button>
                <div id="list-folders">
                    <div class="folder-item active" onclick="changeFolder('General', this)">üìÅ General</div>
                </div>
            </aside>

            <section class="editor-container">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 id="folder-display">Carpeta: General</h2>
                    <div>
                        <span id="msg" style="margin-right:10px; color:green; font-size:0.9em;"></span>
                        <button class="btn-save" id="save-btn">Guardar Cambios</button>
                    </div>
                </div>
                <textarea id="notes-area" placeholder="Escribe tus apuntes aqu√≠..."></textarea>
            </section>
        </div>
    </main>

    <script type="module">
        import { db, auth } from './firebase-config.js';
        import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        let currentFolder = "General";
        const textarea = document.getElementById('notes-area');
        const folderTitle = document.getElementById('folder-display');
        const saveMsg = document.getElementById('msg');

        // 1. Iniciar Sesi√≥n y Cargar Carpeta Inicial
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('user-name').textContent = user.displayName;
                document.getElementById('user-photo').src = user.photoURL;
                loadFolderData(user.uid, currentFolder);
            } else {
                window.location.href = 'login.html';
            }
        });

        // 2. Funci√≥n para cargar datos de Firebase
        async function loadFolderData(uid, folderName) {
            textarea.value = "Cargando...";
            const docRef = doc(db, "users", uid, "apuntes", folderName);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    textarea.value = docSnap.data().contenido;
                } else {
                    textarea.value = ""; // Si no existe, √°rea limpia
                }
                folderTitle.textContent = `Carpeta: ${folderName}`;
            } catch (error) {
                console.error("Error al cargar:", error);
            }
        }

        // 3. Funci√≥n para Guardar
        document.getElementById('save-btn').onclick = async () => {
            const user = auth.currentUser;
            if (user) {
                saveMsg.textContent = "Guardando...";
                const docRef = doc(db, "users", user.uid, "apuntes", currentFolder);
                try {
                    await setDoc(docRef, {
                        contenido: textarea.value,
                        fecha: new Date()
                    });
                    saveMsg.textContent = "Guardado ‚úÖ";
                    setTimeout(() => saveMsg.textContent = "", 2000);
                } catch (error) {
                    alert("Error al guardar: " + error.message);
                }
            }
        };

        // 4. Crear Carpeta Nueva
        document.getElementById('add-folder').onclick = () => {
            const name = prompt("Nombre de la carpeta:");
            if (name) {
                const list = document.getElementById('list-folders');
                const div = document.createElement('div');
                div.className = 'folder-item';
                div.innerHTML = `üìÅ ${name}`;
                div.onclick = () => changeFolder(name, div);
                list.appendChild(div);
                changeFolder(name, div); // Cambiar a la carpeta reci√©n creada
            }
        };

        // 5. Cambiar de Carpeta (Global)
        window.changeFolder = (name, element) => {
            // Est√©tica: Cambiar clase active
            document.querySelectorAll('.folder-item').forEach(i => i.classList.remove('active'));
            element.classList.add('active');
            
            // L√≥gica: Cargar datos de la nueva carpeta
            currentFolder = name;
            const user = auth.currentUser;
            if (user) loadFolderData(user.uid, name);
        };
    </script>
</body>
</html>