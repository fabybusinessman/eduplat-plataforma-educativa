<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduPlat - Mis Apuntes por Carpeta</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        :root {
            --primary-color: #4a90e2; --background-light: #f8f9fa;
            --background-white: #ffffff; --text-dark: #343a40;
            --text-light: #6c757d; --border-color: #dee2e6;
            --shadow: 0 4px 15px rgba(0,0,0,0.05); --border-radius: 12px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--background-light); display: flex; min-height: 100vh; }

        /* Sidebar Principal */
        .sidebar { width: 260px; background: white; height: 100vh; position: fixed; border-right: 1px solid var(--border-color); padding: 30px 20px; }
        .nav-link { text-decoration: none; color: var(--text-light); display: flex; padding: 12px; gap: 12px; border-radius: 8px; margin-bottom: 5px; }
        .nav-link.active { background: #eef5ff; color: var(--primary-color); font-weight: 600; }

        /* Contenido Principal */
        .main-content { margin-left: 260px; width: calc(100% - 260px); padding: 30px; display: flex; flex-direction: column; }
        
        /* Layout de Apuntes */
        .notes-wrapper { display: grid; grid-template-columns: 280px 1fr; gap: 25px; margin-top: 20px; flex-grow: 1; }
        
        /* Listado de Carpetas */
        .folders-panel { background: white; border-radius: var(--border-radius); padding: 20px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .folder-item { 
            padding: 12px 15px; cursor: pointer; border-radius: 8px; margin-bottom: 8px; 
            transition: 0.2s; color: var(--text-dark); display: flex; align-items: center; gap: 10px;
        }
        .folder-item:hover { background: #f0f7ff; }
        .folder-item.active { background: var(--primary-color); color: white; }

        .btn-new-folder { 
            width: 100%; padding: 12px; border: 2px dashed var(--primary-color); 
            color: var(--primary-color); background: white; border-radius: 8px; 
            cursor: pointer; margin-bottom: 20px; font-weight: 600;
        }

        /* Editor de Texto */
        .editor-container { 
            background: white; border-radius: var(--border-radius); padding: 25px; 
            box-shadow: var(--shadow); border: 1px solid var(--border-color); 
            display: flex; flex-direction: column; 
        }
        .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #notes-textarea { 
            flex-grow: 1; width: 100%; border: 1px solid #eee; border-radius: 10px; 
            padding: 20px; font-family: inherit; font-size: 1.05rem; line-height: 1.6;
            resize: none; outline: none; background: #fafafa;
        }
        .btn-save-note { 
            background: var(--primary-color); color: white; border: none; 
            padding: 12px 30px; border-radius: 8px; cursor: pointer; font-weight: 600;
            box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3);
        }

        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; width: 100%; }
            .notes-wrapper { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <aside class="sidebar">
        <h2 style="color:var(--primary-color); margin-bottom: 30px;">üéì EduPlat</h2>
        <nav>
            <a href="dashboard.html" class="nav-link">üè† Dashboard</a>
            <a href="cursos.html" class="nav-link">üìö Mis Cursos</a>
            <a href="apuntes.html" class="nav-link active">üìù Apuntes</a>
            <a href="configuracion.html" class="nav-link">‚öôÔ∏è Configuraci√≥n</a>
            <a href="cerrarsesion.html" class="nav-link" style="margin-top:30px; color:#dc3545;">üö™ Salir</a>
        </nav>
    </aside>

    <main class="main-content">
        <header style="display:flex; justify-content:space-between; align-items:center;">
            <h1>Mis Apuntes</h1>
            <div style="display:flex; align-items:center; gap:10px; background:white; padding:8px 15px; border-radius:50px; box-shadow:var(--shadow);">
                <span id="user-name" style="font-weight:500;">Cargando...</span>
                <img id="user-photo" src="" style="width:30px; height:30px; border-radius:50%;">
            </div>
        </header>

        <div class="notes-wrapper">
            <aside class="folders-panel">
                <button class="btn-new-folder" id="add-folder-btn">+ Nueva Carpeta</button>
                <div id="folders-list">
                    <div class="folder-item active" onclick="selectFolder('General', this)">üìÅ General</div>
                </div>
            </aside>

            <section class="editor-container">
                <div class="editor-header">
                    <h2 id="current-folder-name">Carpeta: General</h2>
                    <div style="display:flex; align-items:center; gap:15px;">
                        <span id="save-indicator" style="color: #2ecc71; font-weight: 500;"></span>
                        <button class="btn-save-note" id="save-note-btn">Guardar Apuntes</button>
                    </div>
                </div>
                <textarea id="notes-textarea" placeholder="Empieza a escribir tus notas de esta carpeta..."></textarea>
            </section>
        </div>
    </main>

    <script type="module">
        import { db, auth } from './firebase-config.js';
        import { doc, getDoc, setDoc, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        let activeFolder = "General";
        const textarea = document.getElementById('notes-textarea');
        const saveBtn = document.getElementById('save-note-btn');
        const saveIndicator = document.getElementById('save-indicator');

        // 1. Verificaci√≥n de Usuario
        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('user-name').textContent = user.displayName;
                document.getElementById('user-photo').src = user.photoURL;
                
                // Cargar el contenido de la carpeta inicial
                loadFolderContent(user.uid, activeFolder);
            } else {
                window.location.href = 'login.html';
            }
        });

        // 2. Cargar contenido de una carpeta espec√≠fica
        async function loadFolderContent(uid, folderName) {
            textarea.value = "Cargando...";
            try {
                const docRef = doc(db, "users", uid, "apuntes", folderName);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    textarea.value = docSnap.data().contenido;
                } else {
                    textarea.value = ""; // Carpeta nueva/vac√≠a
                }
                document.getElementById('current-folder-name').textContent = `Carpeta: ${folderName}`;
            } catch (e) {
                console.error("Error cargando notas:", e);
            }
        }

        // 3. Guardar Apuntes
        saveBtn.onclick = async () => {
            const user = auth.currentUser;
            if (user && textarea.value !== "Cargando...") {
                saveIndicator.textContent = "Guardando...";
                try {
                    const docRef = doc(db, "users", user.uid, "apuntes", activeFolder);
                    await setDoc(docRef, {
                        contenido: textarea.value,
                        ultima_edicion: new Date()
                    });
                    saveIndicator.textContent = "Guardado ‚úÖ";
                    setTimeout(() => saveIndicator.textContent = "", 2000);
                } catch (e) {
                    alert("Error al guardar: " + e.message);
                }
            }
        };

        // 4. Crear Nueva Carpeta (Visualmente)
        document.getElementById('add-folder-btn').onclick = () => {
            const folderName = prompt("Nombre de la nueva carpeta:");
            if (folderName && folderName.trim() !== "") {
                const div = document.createElement('div');
                div.className = 'folder-item';
                div.innerHTML = `üìÅ ${folderName}`;
                div.onclick = () => selectFolder(folderName, div);
                document.getElementById('folders-list').appendChild(div);
                
                // Cambiar autom√°ticamente a la nueva carpeta
                selectFolder(folderName, div);
            }
        };

        // 5. Funci√≥n para cambiar de carpeta
        window.selectFolder = (folderName, element) => {
            // Quitar clase activa de los dem√°s
            document.querySelectorAll('.folder-item').forEach(item => item.classList.remove('active'));
            // Poner clase activa al actual
            element.classList.add('active');
            
            activeFolder = folderName;
            const user = auth.currentUser;
            if (user) loadFolderContent(user.uid, folderName);
        };
    </script>
</body>
</html>